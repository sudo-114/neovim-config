#!/bin/bash

# --- DEFAULT VARIABLES ---
PUBLIC_MODE=false
TARGET_DIR="."
DEFAULT_PORT=3000
TUNNEL_LOG="$HOME/.tunnel.log"

# ---- COLORS ----
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

# --- CLEANUP ---
cleanup() {
    # Kill all background jobs (the tunnel)
    pkill -P $$ 2>/dev/null
    rm -f "$TUNNEL_LOG"
}
trap cleanup EXIT INT TERM HUP QUIT

# --- LOGO ---
logo() {
    echo -e "${BOLD}${CYAN}"
    cat <<'EOF'
            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
            ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo -e "${RESET}"
}

# --- GLOBAL INSTALLER ---
# This allows 'serve --install' to work from anywhere
install_globally() {
    local target="$PREFIX/bin/serve"
    local source
    source=$(realpath "$0")
    local shell=$(basename "$SHELL")

    echo -e "üîó Linking ${BOLD}'$source'${RESET} to ${BOLD}'$target'${RESET}...\n"
    ln -sf "$source" "$target"
    chmod +x "$target"

    local runner='alias serve=". $PREFIX/bin/serve"'

    if [ "$shell" = "bash" ]; then
        local shell_conf="bashrc"
    elif [ "$shell" = "zsh" ]; then
        local shell_conf="zshrc"
    else
        local shell_conf="bashrc" # fallback
    fi

    [ ! -f ~/.$shell_conf ] && touch ~/.$shell_conf

    if ! grep -q "$runner" ~/.$shell_conf; then
        echo "$runner" >>~/.$shell_conf
        echo -e "‚úÖ Alias added to ${BOLD}~/.$shell_conf${RESET}\nRun '${BOLD}source ~/.$shell_conf${RESET}' or restart your shell to activate.\n"
    fi

    return 0 2>/dev/null || exit 0
}

# --- HELP MENU ---
show_help() {
    echo "SERVE v1.1"
    echo "Usage: serve [path] [options]"
    echo
    echo "Options:"
    echo "  [path]            Directory to serve (default: current)"
    echo "  -p, --port [num]  Specify port (default: 3000)"
    echo "  --public          Enable public URL & QR code"
    echo "  -i, --install     Link 'serve' to your system bin"
    echo "  -h, --help        Show this message"
}

# Check pkgs
check_dep() {
    local cmd_name="$1"
    local pkg_name="$1"

    if ! command -v "$cmd_name" &>/dev/null; then
        echo -e "‚ö†Ô∏èDependency missing: $cmd_name is not installed.\n"

        # Map command names to actual package names
        [[ "$cmd_name" == "node" ]] && pkg_name="nodejs"

        local install_cmd="sudo apt install $pkg_name -y"
        [[ -n "$TERMUX_VERSION" ]] && install_cmd="pkg install $pkg_name -y"

        echo "üëâ Press [Enter] to run '$install_cmd' or [q] to quit: "
        read -r choice

        [[ -n "$choice" ]] && echo -e "${RED}‚ùå Cannot continue without $cmd_name. Exiting.${RESET}" && exit 1

        echo -e "\nRunning install...\n"
        eval "$install_cmd"
    fi
}

is_port_free() {
    (echo >/dev/tcp/127.0.0.1/$1) >/dev/null 2>&1 && return 1 || return 0
}

find_free_port() {
    local port="$1"
    local max=65535

    while ! is_port_free "$port"; do
        ((port++))
        if ((port > max)); then
            echo -e "${RED}‚ùå No free ports available${RESET}" >&2
            exit 1
        fi
    done

    echo "$port"
}

get_local_ip() {
    # Tries to find the LAN IP address
    ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | head -n 1
}

PORT=$(find_free_port "$DEFAULT_PORT")

# A faster check that just installs if missing
silent_install() {
    if ! command -v "$1" &>/dev/null; then
        echo "üîß Installing $1..."
        if [[ -n "$TERMUX_VERSION" ]]; then
            pkg install "$1" -y &>/dev/null
        else
            sudo apt install "$1" -y &>/dev/null
        fi
    fi
}

# --- TUNNEL ENGINE ---
get_tunnel_url() {
    # Check for internet before trying
    while ! ping -c 1 google.com &>/dev/null; do
        echo -e "${YELLOW}Waiting for internet connection...${RESET}" >/dev/tty
        sleep 5
    done

    : >"$TUNNEL_LOG"
    while [ ! -s "$TUNNEL_LOG" ]; do
        ssh -n -R 80:localhost:"$PORT" -o StrictHostKeyChecking=no -o ServerAliveInterval=60 nokey@localhost.run >"$TUNNEL_LOG" 2>&1 &
        sleep 2
    done

    PUBLIC_URL=""
    while [ -z "$PUBLIC_URL" ]; do
        echo "üåê Waiting for tunnel url..."
        sleep 2
        PUBLIC_URL=$(grep -o 'https://[^ ]*\.lhr.life' "$TUNNEL_LOG" | head -n 1)
    done
}

# --- PUBLIC TUNNEL ENGINE ---
start_public_tunnel() {
    # Ensure they have SSH and QR tools
    silent_install "ssh"

    [[ -n $TERMUX_VERSION ]] && silent_install "libqrencode"
    silent_install "qrencode"

    if [[ ! -f "$TUNNEL_LOG" ]]; then
        touch "$TUNNEL_LOG"
    fi

    echo -e "\nüîÑ ${DIM}Initializing tunnel...${RESET}"
    get_tunnel_url

    (
        while true; do
            URL=$(grep -o 'https://[^ ]*\.lhr.life' "$TUNNEL_LOG" | tail -n 1)
            if [ "$URL" != "$PUBLIC_URL" ] && [ -n "$URL" ]; then
                PUBLIC_URL="$URL"
                echo -e "\nüåê ${BOLD}New tunnel URL:${RESET} ${BLUE}$URL${RESET}\n" >/dev/tty
            fi

            if tail "$TUNNEL_LOG" | grep -Eqi 'disconnect|closed|broken'; then
                echo -e "\n‚ö†Ô∏è ${BOLD}Tunnel disconnected/closed${RESET} at $(date)" >/dev/tty
                echo -e "üîÑ Restarting tunnel...\n" >/dev/tty
                get_tunnel_url
                echo -e "\nüåê ${BOLD}New tunnel URL:${RESET} ${BLUE}$PUBLIC_URL${RESET}\n" >/dev/tty
            fi
            sleep 2
        done
    ) &

    echo
}

render_ui() {
    clear
    logo
    local local_ip=$(get_local_ip)

    echo -e "${BOLD}üìÇ Project:${RESET}  $PROJECT_TYPE"
    echo -e "${BOLD}üìç Local:${RESET}    http://localhost:$PORT"
    if [[ -n "$local_ip" ]]; then
        echo -e "${BOLD}üè† Network:${RESET}  http://$local_ip:$PORT"
    fi

    if [[ "$PUBLIC_MODE" == "true" && -n "$PUBLIC_URL" ]]; then
        echo -e "${BOLD}üåç Public:${RESET}   ${BLUE}$PUBLIC_URL${RESET}"
        echo
        if command -v qrencode &>/dev/null; then
            echo -e "${DIM}Scan for public access:${RESET}\n"
            qrencode -t ansiutf8 "$PUBLIC_URL"
        fi
    fi

    if [[ "$PUBLIC_MODE" == "true" && ! -n "$PUBLIC_URL" ]]; then
        echo -e "\n${RED}‚ùå Tunnel unreachable. Check your internet connection.${RESET}"
    fi

    echo -e "\n${DIM}Press Ctrl+C to stop${RESET}\n"
}

# --- THE ARGUMENT EATER ---
# This loop processes everything you type after the command 'serve'
while [[ "$#" -gt 0 ]]; do
    case "$1" in
    -i | --install)
        install_globally
        return 0 2>/dev/null || exit 0
        ;;
    --public) PUBLIC_MODE=true ;;
    -p | --port)
        PORT="$2"
        shift
        ;;
    -h | --help)
        show_help
        return 0 2>/dev/null || exit 0
        ;;
    *)
        if [ -d "$1" ]; then
            TARGET_DIR="$1"
        else
            echo -e "${RED}‚ùå Error: '$1' is not a valid option or directory.${RESET}"
            exit 1
        fi
        ;;
    esac
    shift
done

# Jump into the project folder before we start detecting files
# Clean up the path for the UI
DISPLAY_PATH="${TARGET_DIR/#$HOME/\~}"

# Professional spacing
echo
echo -e "üìÇ ${BOLD}Serving:${RESET} $DISPLAY_PATH"
echo "--------------------------------"

cd "$TARGET_DIR" || exit 1

# --- DETECTION ENGINE ---
# We do the work silently first
if [[ -f "package.json" ]]; then
    PROJECT_TYPE="node"

    [[ -f "pnpm-lock.yaml" ]] && MANAGER="pnpm" ||
        [[ -f "bun.lockb" ]] && MANAGER="bun" ||
        [[ -f "yarn.lock" ]] && MANAGER="yarn" || MANAGER="npm"

    # Then we print one clean line
    echo -e "üöÄ${GREEN} Node.js project detected: $MANAGER${RESET}"
    check_dep "node"

elif [[ -f "index.php" ]] || find . -maxdepth 1 -name "*.php" | grep -q .; then
    PROJECT_TYPE="php"

    echo -e "üêò ${MAGENTA}PHP project detected${RESET}"
    check_dep "php"

else
    PROJECT_TYPE="static"

    echo -e "üåê ${YELLOW}Static site detected${RESET}"
    check_dep "python3"
fi

# --- START TUNNELING ---
[[ "$PUBLIC_MODE" == "true" ]] && start_public_tunnel

sleep 1
render_ui

# --- LAUNCH ENGINE ---
case "$PROJECT_TYPE" in
node)
    echo -e "‚ö° ${DIM}Starting $MANAGER development server...${RESET}\n"
    # We use 'exec' so the server takes over the process
    $MANAGER run dev || $MANAGER start
    ;;

php)
    echo -e "‚ö° ${DIM}Starting PHP built-in server on port $PORT...${RESET}\n"
    php -S 0.0.0.0:"$PORT"
    ;;

static)
    echo -e "‚ö° ${DIM}Starting Python static server on port $PORT...${RESET}\n"
    python3 -m http.server "$PORT"
    ;;
esac
